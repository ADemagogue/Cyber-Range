name: Cyber-Range CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]

jobs:
  # ── 1. Lint shell scripts ─────────────────────────────────
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck

      - name: Lint shell scripts
        run: |
          find . -name '*.sh' -not -path './rts/scripts/buildredteam.sh' \
            -not -path './.git/*' \
            -exec shellcheck --severity=warning {} +

      # buildredteam.sh is legacy — lint separately with relaxed rules
      - name: Lint buildredteam.sh (informational)
        continue-on-error: true
        run: shellcheck --severity=error rts/scripts/buildredteam.sh

  # ── 2. Validate Dockerfiles ───────────────────────────────
  hadolint:
    name: Hadolint Dockerfiles
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Lint Dockerfiles
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: "docker/router/Dockerfile"
          failure-threshold: warning

      - name: Lint all Dockerfiles
        run: |
          for df in docker/*/Dockerfile trafficgen/Dockerfile; do
            echo "=== Linting $df ==="
            docker run --rm -i hadolint/hadolint < "$df" || true
          done

  # ── 3. Validate docker-compose.yml ────────────────────────
  compose-validate:
    name: Compose Config Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate docker-compose.yml syntax
        run: docker compose config --quiet

      - name: Check compose resolves all services
        run: |
          services=$(docker compose config --services)
          echo "Services found:"
          echo "$services"
          # Verify key services exist
          for svc in router rootdns ca-server cert-bootstrap owncloud proxy ntp ms-sites; do
            echo "$services" | grep -q "^${svc}$" || { echo "MISSING: $svc"; exit 1; }
          done
          echo "All required services present."

  # ── 4. Run bats unit tests ────────────────────────────────
  bats-tests:
    name: Bats Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install bats-core
        run: |
          git clone https://github.com/bats-core/bats-core.git /tmp/bats-core
          /tmp/bats-core/install.sh "$HOME/.local"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Install yq (for compose YAML tests)
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Run Router tests
        run: bats tests/router/

      - name: Run Proxy tests
        run: bats tests/proxy/

      - name: Run DNS tests
        run: bats tests/dns/

      - name: Run CA tests
        run: bats tests/ca/

      - name: Run Web Services tests
        run: bats tests/webservices/

      - name: Run NRTS tests
        run: bats tests/nrts/

      - name: Run Traffic tests
        run: bats tests/traffic/

      - name: Run Environment tests
        run: bats tests/env/

      - name: Run Integration tests (config-only, no stack start)
        run: bats tests/integration/

  # ── 5. Docker build test ──────────────────────────────────
  docker-build:
    name: Docker Build (Smoke Test)
    runs-on: ubuntu-latest
    needs: [bats-tests, compose-validate]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build router image
        run: docker build -f docker/router/Dockerfile -t cr-router docker/router/

      - name: Build CA image
        run: docker build -f docker/ca/Dockerfile -t cr-ca .

      - name: Build cert-bootstrap image
        run: docker build -f docker/cert-bootstrap/Dockerfile -t cr-cert-bootstrap .

      - name: Build NRTS image
        run: docker build -f docker/nrts/Dockerfile -t cr-nrts .

      - name: Build traffic-web image
        run: docker build -f docker/traffic-web/Dockerfile -t cr-traffic-web docker/traffic-web/

      - name: Build trafficgen image (parameterized proxy)
        run: docker build --build-arg HTTP_PROXY=http://172.30.0.2:9999 -t cr-trafficgen trafficgen/

  # ── 6. CA PKI integration test (in container) ─────────────
  ca-integration:
    name: CA PKI Integration
    runs-on: ubuntu-latest
    needs: [docker-build]
    steps:
      - uses: actions/checkout@v4

      - name: Build CA image
        run: docker build -f docker/ca/Dockerfile -t cr-ca-test .

      - name: Test PKI initialization in container
        run: |
          docker run --rm \
            -e CA_DOMAIN=globalcert.com \
            -e CA_PASS=password \
            -e BACKDATE_DAYS=30 \
            --entrypoint bash \
            cr-ca-test -c "
              bash /opt/ca-scripts/init-pki.sh && \
              test -f /root/ca/private/root.key.pem && \
              test -f /root/ca/certs/root.crt.pem && \
              test -f /root/ca/intermediate/certs/int.globalcert.com.crt.pem && \
              test -f /root/ca/intermediate/certs/chain.globalcert.com.crt.pem && \
              echo 'PKI init: ALL CHECKS PASSED' || \
              { echo 'PKI init: FAILED'; exit 1; }
            "

      - name: Test PKI idempotency (second run is no-op)
        run: |
          docker run --rm \
            -e CA_DOMAIN=globalcert.com \
            -e CA_PASS=password \
            --entrypoint bash \
            cr-ca-test -c "
              bash /opt/ca-scripts/init-pki.sh && \
              bash /opt/ca-scripts/init-pki.sh 2>&1 | grep -q 'already initialized' && \
              echo 'Idempotency: PASSED' || \
              { echo 'Idempotency: FAILED'; exit 1; }
            "

      - name: Test certificate generation
        run: |
          docker run --rm \
            -e CA_DOMAIN=globalcert.com \
            -e CA_PASS=password \
            -e OUTPUT_DIR=/output \
            --entrypoint bash \
            cr-ca-test -c "
              mkdir -p /output && \
              bash /opt/ca-scripts/init-pki.sh && \
              openssl genrsa -out /root/ca/intermediate/private/dropbox.com.key 2048 && \
              openssl req -new -sha256 \
                -key /root/ca/intermediate/private/dropbox.com.key \
                -out /root/ca/intermediate/csr/dropbox.com.csr \
                -subj '/C=US/ST=Oregon/L=Seattle/O=dropbox.com/CN=dropbox.com' && \
              openssl ca -config /root/ca/intermediate/openssl_intermediate.cnf \
                -extensions server_cert -days 825 -notext -md sha512 \
                -in /root/ca/intermediate/csr/dropbox.com.csr \
                -out /root/ca/intermediate/certs/dropbox.com.crt \
                -passin pass:password -batch && \
              test -f /root/ca/intermediate/certs/dropbox.com.crt && \
              echo 'Cert generation: PASSED' || \
              { echo 'Cert generation: FAILED'; exit 1; }
            "

